<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>

<link rel="stylesheet" href="/ko-la-portfolio/style.css">
</head>

<body>

<header>
    <h1>Admin Panel</h1>
    <a href="/ko-la-portfolio/index.html">‚Üê Back</a>
</header>

<section>

<h2>Upload Photo</h2>

<input type="file" id="fileInput">
<select id="category">
    <option value="Nature">Nature</option>
    <option value="Travel">Travel</option>
    <option value="Art">Art</option>
</select>

<button id="uploadBtn">Upload</button>

<h2>Photo List</h2>
<ul id="photoList"></ul>

</section>

<script type="module">

import { supabase } from '/ko-la-portfolio/supabaseClient.js'

const uploadBtn = document.getElementById('uploadBtn')
const fileInput = document.getElementById('fileInput')
const categorySelect = document.getElementById('category')
const photoList = document.getElementById('photoList')

uploadBtn.addEventListener('click', uploadPhoto)

async function uploadPhoto() {

    const file = fileInput.files[0]
    if (!file) {
        alert("Select file first")
        return
    }

    const category = categorySelect.value
    const fileName = Date.now() + "-" + file.name

    // 1. Upload to Storage
    const { error: uploadError } = await supabase.storage
        .from('photos')
        .upload(fileName, file)

    if (uploadError) {
        console.error(uploadError)
        alert("Upload error")
        return
    }

    // 2. Get public URL
    const { data } = supabase.storage
        .from('photos')
        .getPublicUrl(fileName)

    const publicUrl = data.publicUrl

    // 3. Save to table
    const { error: insertError } = await supabase
        .from('photos')
        .insert([{
            url: publicUrl,
            category: category
        }])

    if (insertError) {
        console.error(insertError)
        alert("Database error")
        return
    }

    alert("Uploaded successfully")
    loadPhotos()
}

async function loadPhotos() {

    const { data, error } = await supabase
        .from('photos')
        .select('*')
        .order('created_at', { ascending: false })

    if (error) {
        console.error(error)
        return
    }

    photoList.innerHTML = ''

    data.forEach(photo => {

        const li = document.createElement('li')
        li.innerHTML = `
            ${photo.category}
            <a href="${photo.url}" target="_blank">View</a>
            <button data-id="${photo.id}">Delete</button>
        `

        li.querySelector('button').addEventListener('click', () => deletePhoto(photo.id))

        photoList.appendChild(li)
    })
}

async function deletePhoto(id) {

    const { error } = await supabase
        .from('photos')
        .delete()
        .eq('id', id)

    if (error) {
        console.error(error)
        return
    }

    loadPhotos()
}

loadPhotos()

</script>

</body>
</html>
